"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function getFormattedDate(dt){return[dt.getFullYear(),("0"+(dt.getMonth()+1)).slice(-2),("0"+dt.getDate()).slice(-2)].join("-")}function getDaysInMonth(year,month){return new Date(year,month+1,0).getDate()}function getClassNameFromSelector(selector){return selector.replace(".","")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),EVENT_DATE_PICKER_YEAR_UPDATE="date-picker:year-update",EVENT_DATE_PICKER_MONTH_UPDATE="date-picker:month-update",EVENT_DATE_PICKER_FORCE_EDIT="date-picker:force-edit",EVENT_DATE_PICKER_ENTER="date-picker:enter",EVENT_DATE_PICKER_EXIT="date-picker:exit",DatePicker=function(){function DatePicker($input){_classCallCheck(this,DatePicker),this.defaults={},this.cssSelectors={dp:".c-date-picker",dpFocused:".c-date-picker--focused",dpDisplay:".c-date-picker__display",dpDropDown:".c-date-picker__drop-down",dpYearWrapper:".c-date-picker__year-wrapper",dpMonthWrapper:".c-date-picker__month-wrapper",dpMonth:".c-date-picker__month",dpCalWrapper:".c-date-picker__cal-wrapper",dpWeekWrapper:".c-date-picker__week-wrapper",dpDate:".c-date-picker__date",dpOverlay:".c-date-picker__overlay",focus:".focus",active:".active",empty:".empty",disabled:".disabled",jsPrevYear:".js-date-picker-prev-year",jsYear:".js-date-picker-year",jsNextYear:".js-date-picker-next-year"},this.$input=$input,this.parseInputAttrs(),this.setup(),this.bindUIActions()}return _createClass(DatePicker,[{key:"parseInputAttrs",value:function(){function parseDateFromString(dateStr){var today=new Date,tomorrow=new Date(today.getFullYear(),today.getMonth(),today.getDate()+1);switch(dateStr){case"today":return today;case"tomorrow":return tomorrow;default:return new Date(dateStr)}}var minDateStr=this.$input.data("min-date"),minDate=parseDateFromString(minDateStr);isNaN(minDate)||(this.defaults.minDate=minDate);var valueStr=this.$input.val(),value=parseDateFromString(valueStr);isNaN(value)?this.defaults.value=parseDateFromString("today"):this.defaults.value=value}},{key:"setup",value:function(){var dpClass=getClassNameFromSelector(this.cssSelectors.dp),dpDisplayClass=getClassNameFromSelector(this.cssSelectors.dpDisplay),dpDropDown=getClassNameFromSelector(this.cssSelectors.dpDropDown);this.$dp=$('<div class="'+dpClass+'"></div>'),this.$dp.insertAfter(this.$input),this.$dpDisplay=$('<input type="text" class="'+dpDisplayClass+'" readonly>'),this.$dpDisplay.val(getFormattedDate(this.defaults.value)),this.$dp.append(this.$dpDisplay);var $dpDropDown=$('<div class="'+dpDropDown+'"></div>');this.$dp.append($dpDropDown),this.$dpYearWrapper=$(this._getYearWrapperHtml()),$dpDropDown.append(this.$dpYearWrapper),this.$dpMonthWrapper=$(this._getMonthWrapperHtml()),$dpDropDown.append(this.$dpMonthWrapper),this.$dpCalWrapper=$(this._getCalWrapperHtml()),$dpDropDown.append(this.$dpCalWrapper),this.$input.attr("type","hidden"),this.$dp.append(this.$input),this.$dpOverlay=$(this._getOverlayHtml()),this.$dp.append(this.$dpOverlay)}},{key:"bindUIActions",value:function(){this.$dp.on("focus",this.show.bind(this)),this.$dpDisplay.on("focus",this.show.bind(this)),this.$dpOverlay.on("click",this.hide.bind(this)),this.$dp.on("click",this.cssSelectors.jsPrevYear,function(){this.$year.val(parseInt(this.$year.val())-1),this.$dp.trigger(EVENT_DATE_PICKER_YEAR_UPDATE)}.bind(this)),this.$dp.on("click",this.cssSelectors.jsNextYear,function(){this.$year.val(parseInt(this.$year.val())+1),this.$dp.trigger(EVENT_DATE_PICKER_YEAR_UPDATE)}.bind(this)),this.$year.on("keyup",function(ev){13===ev.keyCode&&(this.updateMonth(),this.$dpMonthWrapper.focus(),this._navigateMonthsWithKeys())}.bind(this)),this.$year.on("blur",function(ev){this.updateMonth(),this.$dpMonthWrapper.focus()}.bind(this)),this.$dp.on(EVENT_DATE_PICKER_YEAR_UPDATE,this.updateMonth.bind(this)),this.$dp.on(EVENT_DATE_PICKER_MONTH_UPDATE,this.updateCal.bind(this)),this.$dp.on("keyup",this.cssSelectors.dpMonthWrapper,this._navigateMonthsWithKeys.bind(this)),this.$dp.on("click",this.cssSelectors.dpMonth,this.selectMonth.bind(this)),this.$dp.on("keyup",this.cssSelectors.dpCalWrapper,this._navigateDateWithKeys.bind(this)),this.$dp.on("click",this.cssSelectors.dpDate,this.selectDate.bind(this)),this.$dp.on(EVENT_DATE_PICKER_FORCE_EDIT,this.forceEditHandler.bind(this)),$("body").on(EVENT_DATE_PICKER_ENTER,function(ev){ev.target!==this.$dp.get(0)&&(this.$dp.removeAttr("tabindex"),this.$dpDisplay.attr("disabled",!0))}.bind(this)),$("body").on(EVENT_DATE_PICKER_EXIT,function(ev){console.log("exit"),ev.target!==this.$dp.get(0)&&(this.$dp.attr("tabindex","0"),this.$dpDisplay.removeAttr("disabled"))}.bind(this))}},{key:"show",value:function(){this.reset(),this.$dp.addClass(getClassNameFromSelector(this.cssSelectors.dpFocused)),this.$dp.trigger(EVENT_DATE_PICKER_ENTER)}},{key:"hide",value:function(){this.$dp.removeClass(getClassNameFromSelector(this.cssSelectors.dpFocused)),this.$dp.trigger(EVENT_DATE_PICKER_EXIT),this.$dp.blur()}},{key:"forceEditHandler",value:function(){this.show(),this.$dp.focus()}},{key:"reset",value:function(){this.$year.val(this.defaults.value.getFullYear()),this.$dpMonthWrapper.remove(),this.$dpMonthWrapper=$(this._getMonthWrapperHtml()),this.$dpMonthWrapper.insertAfter(this.$dpYearWrapper),this.$dpCalWrapper.remove(),this.$dpCalWrapper=$(this._getCalWrapperHtml()),this.$dpCalWrapper.insertAfter(this.$dpMonthWrapper)}},{key:"updateMonth",value:function(){var $oldMonthWrapper=this.$dpMonthWrapper;this.$dpMonthWrapper=$(this._getMonthWrapperHtml()),$oldMonthWrapper.replaceWith(this.$dpMonthWrapper),this.$dp.trigger(EVENT_DATE_PICKER_MONTH_UPDATE)}},{key:"updateCal",value:function(){this.$dpCalWrapper.remove(),this.$dpCalWrapper=$(this._getCalWrapperHtml()),this.$dpCalWrapper.insertAfter(this.$dpMonthWrapper)}},{key:"_navigateMonthsWithKeys",value:function(ev){var focusClass=getClassNameFromSelector(this.cssSelectors.focus),disabledClass=getClassNameFromSelector(this.cssSelectors.disabled),$focussedMonth=this.$dp.find(this.cssSelectors.dpMonth+this.cssSelectors.focus);if($focussedMonth.length||($focussedMonth=this.$dp.find(this.cssSelectors.dpMonth+":not("+this.cssSelectors.disabled+")").first(),$focussedMonth.addClass(focusClass)),ev){var $targetMonth;switch(ev.keyCode){case 37:$targetMonth=$focussedMonth.prev(),$targetMonth.length||($targetMonth=$focussedMonth.siblings(":last")),$targetMonth.hasClass(disabledClass)&&($targetMonth=$focussedMonth.siblings(":not("+this.cssSelectors.disabled+")").last()),$targetMonth.addClass(focusClass).siblings().removeClass(focusClass);break;case 39:$targetMonth=$focussedMonth.next(),$targetMonth.length||($targetMonth=$focussedMonth.siblings(":first")),$targetMonth.hasClass(disabledClass)&&($targetMonth=$focussedMonth.siblings(":not("+this.cssSelectors.disabled+")").first()),$targetMonth.addClass(focusClass).siblings().removeClass(focusClass);break;case 38:case 40:var $months=this.$dp.find(this.cssSelectors.dpMonth),idx=$months.index($focussedMonth);$targetMonth=idx<6?$months.eq(idx+6):$months.eq(idx-6),$targetMonth.hasClass(disabledClass)||$targetMonth.addClass(focusClass).siblings().removeClass(focusClass);break;case 13:$focussedMonth.click(),this.$dpCalWrapper.focus(),this._navigateDateWithKeys()}}}},{key:"_navigateDateWithKeys",value:function(ev){var $dates=this.$dp.find(this.cssSelectors.dpDate).filter(":not("+this.cssSelectors.empty+")"),focusClass=getClassNameFromSelector(this.cssSelectors.focus),disabledClass=getClassNameFromSelector(this.cssSelectors.disabled),$focusedDate=$dates.filter(this.cssSelectors.focus);if($focusedDate.length||($focusedDate=$dates.filter(":not("+this.cssSelectors.disabled+")").first(),$focusedDate.addClass(focusClass)),ev){var $targetDate,idx=$dates.index($focusedDate);switch(ev.keyCode){case 37:$targetDate=0===idx?$dates.filter(":not("+this.cssSelectors.disabled+")").last():$dates.eq(idx-1),$targetDate.hasClass(disabledClass)&&($targetDate=$dates.filter(":not("+this.cssSelectors.disabled+")").last()),$targetDate.addClass(focusClass).siblings().removeClass(focusClass);break;case 39:$targetDate=idx===$dates.length-1?$dates.filter(":not("+this.cssSelectors.disabled+")").first():$dates.eq(idx+1),$targetDate.hasClass(disabledClass)&&($targetDate=$dates.filter(":not("+this.cssSelectors.disabled+")").first()),$targetDate.addClass(focusClass).siblings().removeClass(focusClass);break;case 38:if(idx<=6)return;if($targetDate=$dates.eq(idx-7),!$targetDate.length)return;if($targetDate.hasClass(disabledClass))return;$targetDate.addClass(focusClass).siblings().removeClass(focusClass);break;case 40:if(idx>=$dates.length-7)return;if($targetDate=$dates.eq(idx+7),!$targetDate.length)return;if($targetDate.hasClass(disabledClass))return;$targetDate.addClass(focusClass).siblings().removeClass(focusClass);break;case 13:$focusedDate.click()}}}},{key:"selectMonth",value:function(ev){var $li=$(ev.currentTarget),disabledClass=getClassNameFromSelector(this.cssSelectors.disabled);if(!$li.hasClass(disabledClass)){var activeClass=getClassNameFromSelector(this.cssSelectors.active);$li.siblings("li").removeClass(activeClass),$li.addClass(activeClass),this.$dp.trigger(EVENT_DATE_PICKER_MONTH_UPDATE)}}},{key:"selectDate",value:function(ev){var $li=$(ev.currentTarget),activeClass=getClassNameFromSelector(this.cssSelectors.active);$li.siblings("li").removeClass(activeClass),$li.addClass(activeClass);var year=this.$year.val(),month=this._getSelectedMonth(),selectedDate=parseInt($li.text());this.defaults.value=new Date(year,month,selectedDate),this.$dpDisplay.val(getFormattedDate(this.defaults.value)),this.$input.val(getFormattedDate(this.defaults.value)),this.hide()}},{key:"_getYearWrapperHtml",value:function(){var yearWrapperClass=getClassNameFromSelector(this.cssSelectors.dpYearWrapper),prevYearClass=getClassNameFromSelector(this.cssSelectors.jsPrevYear),yearClass=getClassNameFromSelector(this.cssSelectors.jsYear),nextYearClass=getClassNameFromSelector(this.cssSelectors.jsNextYear);return['<div class="'+yearWrapperClass+'">','<span class="'+prevYearClass+' fa fa-caret-left"></span>','<input type="text" class="'+yearClass+'" value="'+this.defaults.value.getFullYear()+'">','<span class="'+nextYearClass+' fa fa-caret-right"></span>',"</div>"].join("")}},{key:"_getMonthWrapperHtml",value:function(){this.$year||(this.$year=this.$dp.find(this.cssSelectors.jsYear));var monthLabels=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],curDate=new Date(this.$year.val(),0,1),isActiveYear=curDate.getFullYear()===this.defaults.value.getFullYear(),activeMonth=this.defaults.value.getMonth(),enabledMonth=0;this.defaults.minDate&&(curDate.getFullYear()<this.defaults.minDate.getFullYear()?enabledMonth=12:curDate.getFullYear()===this.defaults.minDate.getFullYear()&&(enabledMonth=this.defaults.minDate.getMonth()));for(var monthWrapperClass=getClassNameFromSelector(this.cssSelectors.dpMonthWrapper),monthClass=getClassNameFromSelector(this.cssSelectors.dpMonth),disabledClass=getClassNameFromSelector(this.cssSelectors.disabled),activeClass=getClassNameFromSelector(this.cssSelectors.active),html=['<ul class="'+monthWrapperClass+'" tabindex="0">'],i=0;i<12;i++){var classList=[monthClass];i<enabledMonth?classList.push(disabledClass):isActiveYear&&i===activeMonth&&classList.push(activeClass);var li=["<li",'data-month="'+i+'"','class="'+classList.join(" ")+'"'];li.push(">"+monthLabels[i]+"</li>"),html.push(li.join(" "))}return html.push("</ul>"),html.join("")}},{key:"_getCalWrapperHtml",value:function(){var dpCalWrapper=getClassNameFromSelector(this.cssSelectors.dpCalWrapper),dpWeekWrapper=getClassNameFromSelector(this.cssSelectors.dpWeekWrapper),dpDate=getClassNameFromSelector(this.cssSelectors.dpDate),disabledClass=getClassNameFromSelector(this.cssSelectors.disabled),activeClass=getClassNameFromSelector(this.cssSelectors.active),emptyClass=getClassNameFromSelector(this.cssSelectors.empty),html=['<div class="'+dpCalWrapper+'" tabindex="0">'],weekDayLabels=["S","M","T","W","T","F","S"];html.push('<ul class="'+dpWeekWrapper+'">');for(var i=0;i<7;i++)html.push('<li class="'+[dpDate,emptyClass].join(" ")+'">'+weekDayLabels[i]+"</li>");html.push("</ul>"),html.push('<ul class="'+dpWeekWrapper+'">');var selectedYear=this.$year.val(),selectedMonth=this._getSelectedMonth();if(-1!==selectedMonth){var curDate=new Date(selectedYear,selectedMonth,1),enabledDate=1,isActiveYear=curDate.getFullYear()===this.defaults.value.getFullYear(),isActiveMonth=curDate.getMonth()===this.defaults.value.getMonth(),activeDate=this.defaults.value.getDate();this.defaults.minDate&&(curDate.getFullYear()<this.defaults.minDate.getFullYear()?enabledDate=32:curDate.getFullYear()===this.defaults.minDate.getFullYear()&&(curDate.getMonth()<this.defaults.minDate.getMonth()?enabledDate=32:curDate.getMonth()===this.defaults.minDate.getMonth()&&(enabledDate=this.defaults.minDate.getDate())));for(var e=0;e<curDate.getDay();e++)html.push('<li class="'+[dpDate,emptyClass].join(" ")+'">&nbsp;</li>');for(var maxDate=getDaysInMonth(selectedYear,selectedMonth),d=1;d<=maxDate;d++){var classList=[dpDate];d<enabledDate?classList.push(disabledClass):isActiveYear&&isActiveMonth&&d===activeDate&&classList.push(activeClass),html.push('<li class="'+classList.join(" ")+'">'+d+"</li>")}return html.push("</ul>"),html.push("</div>"),html.join("")}}},{key:"_getSelectedMonth",value:function(){var $selectedMonth=this.$dp.find(this.cssSelectors.dpMonth+this.cssSelectors.active);return this.$dp.find(this.cssSelectors.dpMonth).index($selectedMonth)}},{key:"_getOverlayHtml",value:function(){return'<div class="'+getClassNameFromSelector(this.cssSelectors.dpOverlay)+'"></div>'}}]),DatePicker}();$.fn.datepicker=function(){$(this).each(function(){var $input=$(this);new DatePicker($input)})};